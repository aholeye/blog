---
title: "家庭网络布局搭建"
date: '2024-06-25 22:05:11'
summary: "Home Network Layout Guide"
---

## 前言
我家有三个房间，最简单的网络布局，每个房间有一跟网线是从弱电箱走到房间，弱电箱中只有一个光猫，带有四个千兆网口，三根网线直接从光猫中接出。我在家中布线的时候，就是把这三根网线接到了三个房间的网口上，然后在每个房间中接了一个小米路由器。由于每个小米路由器都来自同一个上级路由(光猫)，所以可以开启Mesh，在不同房间中无缝切换WiFi信号。并且主Mesh节点采用中继模式，因此不同路由器下的设备都可以互相访问。

另外，我家一直有一个NAS设备，用于存储家庭中的一些文件。NAS放在书房，从书房的路由器接出一根网线，接到NAS上，这样就可以在家庭中的任何一个房间访问NAS中的文件。

今年5月替换了NAS的基础硬件设备（主板、CPU、电源等），同时也因为一些不可抗力因素导致容器镜像无法随心所欲拉取，因此才下定决心想要通过openwrt优化家庭网络，便于内网设备访问`互联网`

## 准备工作
我们知道要想搞openwrt，首先需要有网口，由于我的NAS只有一个2.5G网口，我已经给NAS用了，因此我需要额外的网口用来给openwrt使用。我在pdd上购入了一张pcie网卡，带有2个2.5G网口，这样就可以给openwrt使用了。

我的NAS系统是Unraid，我需要在Unraid中安装openwrt虚拟机，将pcie网卡直通给openwrt虚拟机，这样openwrt就有了两个网口。这里我就不讲解Unraid如何直通网卡和安装openwrt虚拟机了，只讲解和网络本身有关的openwrt的配置。

> pdd上购入的网卡是`Intel I226-V`，价格是`165.83￥`，有需要可以参考一下价格。

## 网络预期

- 三个房间下的所有设备通过openwrt访问互联网
- 三个房间下的所有设备可以互相访问
- 三个房间下的所有设备可以访问NAS中的文件（其实在第二点中已经涵盖）
- 原来的路由器仍然可以组成Mesh网络，用于WiFi覆盖

> 写到此处时，不得不说当时购入网卡的时候，没有事先做好功课，没有准备详细的网路规划，导致后续的配置工作变得复杂，因此在购入硬件之前，一定要做好功课，明确自己的需求。

## 心路历程

还是先记录下我对当时的选择的纠结，我有两个（大致）选择：
1. 在弱电箱中加装openwrt设备，这样就可以直接在弱电箱中接入所有的网线，然后在弱电箱中配置好openwrt，这样就可以直接实现所有设备访问互联网。这是最简易的方案，但是我考虑的：
> - 我除了NAS还要再加一个设备，我对增加一个设备的方案有一丝排斥
> - 一个4网口的设备支持openwrt最佳选择是n100工控机，但是价格在接近`800￥`，我觉得有点贵；或者j1900/j4125主板，价格也在`500￥`左右，我觉得还是有点贵
> - 我已经买了pcie网卡，如果再买一个设备，那么pcie网卡就没有用武之地了（沉默成本）
2. 在NAS中安装openwrt虚拟机，然后直通网卡给openwrt使用，这样也可以实现所有设备访问互联网。但是NAS的位置在书房，而弱电箱到书房仅有一根网线，显然这是一个严重的缺陷。为了解决这个缺陷，就不得不引入一个技术叫做`VLAN`，这样就可以在一根网线上实现多个网段的通信。

此时我就纠结了，我是选择简单的方案，还是选择复杂的方案。最终我选择了复杂的方案，因为我觉得这样可以学到更多的东西，也可以更好的利用我购入的硬件。（GPT生成😀）

## 关于VLAN

VLAN是一种虚拟局域网技术，可以将一个物理局域网划分为多个逻辑上的局域网，这样就可以在一个物理局域网上实现多个逻辑上的局域网之间的通信。

在我的网络中，我的目标是这一根从弱电箱到书房的网线，可以当成两根网线使用。

我用我的话通俗的解释下VLAN的特性：
- 网络数据是可以带`标记`的
- 网口可以设定接收和发送的`标记`
- 网口设定好的标记相当于`卡`，经过这道`卡`的数据，可以根据`卡`的标记来决定是否接收或者发送，和网口与网口之间是否连通
> 我所理解的概念来自以下两个链接：
> - [VLAN基础概念](https://www.cnblogs.com/gzxbkk/p/7805823.html)
> - [B站司波图老师的视频](https://www.bilibili.com/video/BV1e34y1Q7bj)（如果直接看第二期比较吃力，可以先看第一期）

> 其实到这里又有了新的问题，我需要一个（也可能是两个）支持VLAN的交换机，这样才能实现VLAN的划分。我看的网上的教程都是通过这个叫`网管交换机`的设备实现的，所以我并不清楚我自己能否在不购入`网管交换机`的情况下实现VLAN的划分。

总之就是折腾呗！

## openwrt配置